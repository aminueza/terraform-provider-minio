name: Create Release Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (leave empty to auto-calculate from release_type)"
        required: false
        type: string
        default: ""
      release_type:
        description: "Type of release (used when version is empty)"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: "patch"

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest version and calculate next
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Remove 'v' prefix for calculation
          LATEST_VERSION=${LATEST_TAG#v}
          
          # Split into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          
          # Use manual version if provided, otherwise calculate
          MANUAL_VERSION="${{ github.event.inputs.version }}"
          
          if [[ -n "$MANUAL_VERSION" ]]; then
            # Validate manual version format
            if [[ ! "$MANUAL_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Version must be in format X.Y.Z (e.g., 3.15.0)"
              exit 1
            fi
            NEW_VERSION="$MANUAL_VERSION"
            echo "Using manual version: $NEW_VERSION"
          else
            # Calculate based on release type
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            case "$RELEASE_TYPE" in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
                ;;
            esac
            echo "Calculated $RELEASE_TYPE version: $NEW_VERSION"
          fi
          
          echo "latest=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "new=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=v$NEW_VERSION" >> $GITHUB_ENV

      - name: Check tag doesn't exist
        run: |
          if git rev-parse "${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ env.VERSION }} already exists"
            exit 1
          fi

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ env.VERSION }}" -m "Release ${{ env.VERSION }}"
          git push origin "${{ env.VERSION }}"

      - name: Summary
        run: |
          echo "## Release Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous** | \`${{ steps.version.outputs.latest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **New Tag** | \`${{ steps.version.outputs.new }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Type** | \`${{ github.event.inputs.release_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The [Release workflow](../actions/workflows/release.yml) will now build and publish the provider with auto-generated release notes." >> $GITHUB_STEP_SUMMARY
